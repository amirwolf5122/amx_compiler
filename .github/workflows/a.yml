name: amxx

on:
  workflow_dispatch:

jobs:
  linux:
    name: Linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: RUN..
        run: |
          cd scripting
          chmod +x *
          ./compile.sh
          ls -l compiled  # بررسی محتویات دایرکتوری compiled
          zip -r compiled.zip compiled  # ایجاد فایل zip از دایرکتوری compiled

      - name: Upload compiled.zip
        uses: actions/upload-artifact@v4
        with:
          name: compiled.zip  # نام artifact
          path: scripting/compiled.zip  # مسیر دقیق فایل zip

      - name: Deploy
        uses: s0/git-publish-subdir-action@master
        env:
          REPO: self
          BRANCH: data_build
          FOLDER: scripting/compiled
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [linux]
    steps:
      - name: Fetch artifacts
        uses: actions/download-artifact@v4
        with:
          name: compiled.zip  # دانلود artifact با نام دقیق
      - name: Remove old release
        uses: dev-drprasad/delete-tag-and-release@v1.0
        with:
          tag_name: continuous
          delete_release: true
          github_token: ${{ secrets.GITHUB_TOKEN }}  # ارسال توکن معتبر GitHub
      - name: Repackage compiled.zip
        run: |
          mv compiled.zip tfc/compiled.zip
          zip -r tf15-client_compiled.zip tfc/  # ایجاد zip جدید

      - name: Purge artifacts
        uses: geekyeggo/delete-artifact@v2
        with:
          name: "*"

      - name: Upload new release
        uses: svenstaro/upload-release-action@v2
        with:
          file_glob: true
          file: tf15-client_compiled.zip  # فقط فایل compiled.zip منتشر می‌شود
          tag: continuous
          overwrite: true
          prerelease: true
          release_name: CS16Client development build
